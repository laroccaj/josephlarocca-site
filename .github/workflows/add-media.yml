name: Add Media Link

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL(s) - for multiple, separate with commas'
        required: true
      title:
        description: 'Title(s) - for multiple, separate with commas'
        required: true
      source:
        description: 'Source(s) - for multiple, separate with commas'
        required: true

jobs:
  update-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update media.json
        run: |
          # Use jq to handle the inputs as an array and prepend them to the 'news' section
          # This version splits the comma-separated strings into a list
          jq --arg t_str "${{ github.event.inputs.title }}" \
             --arg u_str "${{ github.event.inputs.url }}" \
             --arg s_str "${{ github.event.inputs.source }}" \
             '
             # Create an array of new items from the comma-separated strings
             split($t_str; ",") as $titles |
             split($u_str; ",") as $urls |
             split($s_str; ",") as $sources |
             [range(0; $titles | length)] | 
             map({
               source: ($sources[.] | sub("^\\s+"; "") | sub("\\s+$"; "")),
               title: ($titles[.] | sub("^\\s+"; "") | sub("\\s+$"; "")),
               url: ($urls[.] | sub("^\\s+"; "") | sub("\\s+$"; ""))
             }) as $new_items |
             # Prepend the new items to the existing news array
             .news = ($new_items + .news)
             ' media.json > temp.json && mv temp.json media.json

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add media.json
          git commit -m "Batch add media links: ${{ github.event.inputs.title }}"
          git push
